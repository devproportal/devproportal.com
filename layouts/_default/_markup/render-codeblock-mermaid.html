<div class="mermaid-container">
  <div class="mermaid">
    {{ .Inner }}
  </div>
</div>

{{ if not (.Page.Scratch.Get "mermaidLoaded") }}
  {{ .Page.Scratch.Set "mermaidLoaded" true }}
  <!-- 引入Mermaid库 -->
  <script src="https://unpkg.com/mermaid@11.0.2/dist/mermaid.min.js"></script>

  <script>
    if (!window.mermaidInitialized) {
    window.mermaidInitialized = true;

    // 亮色模式
    const lightThemeVariables = {
        background: '#ffffff',
        primaryColor: '#0969da', // GitHub 主蓝
        primaryTextColor: '#1f2328', // 文本深灰
        primaryBorderColor: '#d0d7de', // 边框灰
        lineColor: '#9ca3af', // 线条灰
        secondaryColor: '#1a7f37', // GitHub 绿色
        tertiaryColor: '#9a6700', // GitHub 黄色
        noteBkgColor: '#f6f8fa', // 注释框背景
        noteTextColor: '#57606a', // 注释文本
        noteBorderColor: '#d0d7de'
    };

    // 暗黑模式 1. Mermaid 官方默认暗黑主题（基础款）
    const darkThemeVariables1 = {
        background: '#2c3e50', // 深灰蓝背景
        primaryColor: '#3498db', // 亮蓝主色（主节点/关键元素）
        primaryTextColor: '#ecf0f1', // 浅灰文本（高对比度）
        primaryBorderColor: '#34495e', // 深灰边框
        lineColor: '#7f8c8d', // 中性灰线条（连接关系）
        secondaryColor: '#2ecc71', // 绿色（次要节点/成功态）
        tertiaryColor: '#f39c12', // 橙色（警示节点/重点）
        noteBkgColor: '#34495e', // 注释框背景
        noteTextColor: '#bdc3c7', // 注释文本
        noteBorderColor: '#2c3e50' // 注释框边框
    };

    // 暗黑模式 2. VS Code 暗黑风格（技术向首选）
    const darkThemeVariables2 = {
        background: '#1e1e1e', // VS Code 暗黑背景
        primaryColor: '#61afef', // 代码高亮蓝（主节点）
        primaryTextColor: '#e0e0e0', // 代码文本灰（避免纯白刺眼）
        primaryBorderColor: '#333333', // 边框深灰
        lineColor: '#5c6370', // 线条灰蓝
        secondaryColor: '#98c379', // 代码高亮绿（次要节点）
        tertiaryColor: '#e5c07b', // 代码高亮黄（警告节点）
        noteBkgColor: '#2d2d2d', // 注释框背景（比主背景稍浅）
        noteTextColor: '#d4d4d4', // 注释文本
        noteBorderColor: '#444444' // 注释框边框
    };

    // 暗黑模式 3. GitHub Dark 风格（社区适配款）
    const darkThemeVariables3 = {
        background: '#0d1117', // GitHub 暗黑背景
        primaryColor: '#58a6ff', // GitHub 链接蓝（主节点）
        primaryTextColor: '#e6edf3', // GitHub 文本灰
        primaryBorderColor: '#30363d', // GitHub 边框灰
        lineColor: '#484f58', // 线条灰（弱对比，避免喧宾夺主）
        secondaryColor: '#3fb950', // GitHub 绿色（成功态节点）
        tertiaryColor: '#d29922', // GitHub 黄色（警告态节点）
        noteBkgColor: '#161b22', // 注释框背景（比主背景稍浅）
        noteTextColor: '#c9d1d9', // 注释文本
        noteBorderColor: '#30363d' // 注释框边框
    };


    function getThemeVariables() {
      // 修改检测逻辑：检查 body 元素是否包含 'dark' 类
      return document.body.classList.contains("dark")
        ? darkThemeVariables1
        : null;
    }

    // 暴露给外部调用（主题切换时用）
    window.renderMermaid = function() {
      mermaid.initialize({
        startOnLoad: true,
        theme: "base",
        themeVariables: getThemeVariables()
      });
      mermaid.init(undefined, document.querySelectorAll('.mermaid'));
    }

    // 初次渲染
    window.renderMermaid();
  }
  </script>
{{ end }}